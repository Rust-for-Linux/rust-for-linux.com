<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Null Block Driver - Rust for Linux</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="Adding support for the Rust language to the Linux kernel">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        
        <link rel="icon" href="Rust-for-Linux.svg">

        <meta property="og:url" content="https://rust-for-linux.com">
        <meta property="og:type" content="website">
        <meta property="og:title" content="Rust for Linux">
        <meta property="og:description" content="Adding support for the Rust language to the Linux kernel">
        <meta property="og:image" content="https://rust-for-linux.com/Rust-for-Linux.svg">
        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "CreativeWork",
            "name": "Rust for Linux",
            "description": "Adding support for the Rust language to the Linux kernel",
            "url": "https://rust-for-linux.com",
            "image": "https://rust-for-linux.com/Rust-for-Linux.svg"
        }
        </script>
        <style>
        #logo {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .rfl-menu-block {
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .rfl-mono-font {
            font-family: var(--mono-font);
        }

        .rfl-mobile-links {
            display: none;
        }

        @media only screen and (max-width: 1080px) {
            .rfl-mobile-links {
                display: block;
            }
        }

        .chapter li.chapter-item {
            margin-top: 0.2em !important;
            margin-left: 1.5em !important;
        }

        .chapter li.part-title {
            margin-bottom: -0.3em !important;
            margin-top: 1em !important;
        }

        .quote-highlight:target {
            /*
             * `--table-header-bg` is used as an existing color in the themes
             * that is good enough for highlighting the `blockquote`s.
             */
            background-color: var(--table-header-bg);
        }
        </style>
    
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            
        <div class="sidebar-scrollbox">
            <a href="/"><img id="logo" src="Rust-for-Linux.svg" alt="Rust for Linux Logo"></a>
            
            <p class="rfl-menu-block">The project</p>
            <ol class="chapter"><li class="chapter-item"><a href="Contact.html" tabindex="0">Contact</a></li><li class="chapter-item"><a href="Contributing.html" tabindex="0">Contributing</a></li><li class="chapter-item"><a href="Rust-kernel-policy.html" tabindex="0">Rust kernel policy</a></li><li class="chapter-item"><a href="Branches.html" tabindex="0">Branches</a></li><li class="chapter-item"><a href="Rust-reference-drivers.html" tabindex="0">Rust reference drivers</a></li><li class="chapter-item"><a href="Rust-version-policy.html" tabindex="0">Rust version policy</a></li><li class="chapter-item"><a href="Unstable-features.html" tabindex="0">Unstable features</a></li><li class="chapter-item"><a href="Backporting-and-stable-LTS-releases.html" tabindex="0">Backporting and stable/LTS releases</a></li><li class="chapter-item"><a href="Third-party-crates.html" tabindex="0">Third-party crates</a></li><li class="chapter-item"><a href="Out-of-tree-modules.html" tabindex="0">Out-of-tree modules</a></li><li class="chapter-item"><a href="Industry-and-academia-support.html" tabindex="0">Industry and academia support</a></li><li class="chapter-item"><a href="Sponsors.html" tabindex="0">Sponsors</a></li><li class="part-title">Subprojects</li><li class="chapter-item"><a href="klint.html" tabindex="0"><span class="rfl-mono-font">klint</span></a></li><li class="chapter-item"><a href="pin-init.html" tabindex="0"><span class="rfl-mono-font">pin-init</span></a></li><li class="part-title">Tools</li><li class="chapter-item"><a href="Coccinelle-for-Rust.html" tabindex="0">Coccinelle for Rust</a></li><li class="chapter-item"><a href="rustc_codegen_gcc.html" tabindex="0"><span class="rfl-mono-font">rustc_codegen_gcc</span></a></li><li class="chapter-item"><a href="gccrs.html" tabindex="0"><span class="rfl-mono-font">gccrs</span></a></li><li class="part-title">Users â€” in mainline</li><li class="chapter-item"><a href="AMCC-QT2025-PHY-Driver.html" tabindex="0">AMCC QT2025 PHY Driver</a></li><li class="chapter-item"><a href="Android-Binder-Driver.html" tabindex="0">Android Binder Driver</a></li><li class="chapter-item"><a href="ASIX-PHY-Driver.html" tabindex="0">ASIX PHY Driver</a></li><li class="chapter-item"><a href="DRM-Panic-QR-code-generator.html" tabindex="0">DRM Panic QR code generator</a></li><li class="chapter-item"><a href="Nova-GPU-Driver.html" tabindex="0">Nova GPU Driver</a></li><li class="chapter-item"><a href="Null-Block-Driver.html" tabindex="0">Null Block Driver</a></li><li class="chapter-item"><a href="Tyr-GPU-Driver.html" tabindex="0">Tyr GPU Driver</a></li><li class="part-title">Users â€” outside mainline</li><li class="chapter-item"><a href="Android-`ashmem`.html" tabindex="0">Android <span class="rfl-mono-font">ashmem</span></a></li><li class="chapter-item"><a href="Apple-AGX-GPU-driver.html" tabindex="0">Apple AGX GPU driver</a></li><li class="chapter-item"><a href="NVMe-driver.html" tabindex="0">NVMe Driver</a></li><li class="chapter-item"><a href="PuzzleFS-filesystem-driver.html" tabindex="0">PuzzleFS filesystem driver</a></li></ol>
        
            <p class="rfl-menu-block">Links</p>
            <ol class="chapter"><li class="part-title">Contact</li><li class="chapter-item"><a href="https://lore.kernel.org/rust-for-linux/" tabindex="0">Lore (mailing list archive)</a></li><li class="chapter-item"><a href="https://rust-for-linux.zulipchat.com" tabindex="0">Zulip (chat)</a></li><li class="chapter-item"><a href="https://github.com/Rust-for-Linux" tabindex="0">GitHub Organization</a></li><li class="part-title">Security</li><li class="chapter-item"><a href="https://docs.kernel.org/process/security-bugs.html" tabindex="0">Report a security bug</a></li><li class="part-title">Issue tracking</li><li class="chapter-item"><a href="https://github.com/Rust-for-Linux/linux/issues" tabindex="0">Issues</a></li><li class="chapter-item"><a href="https://github.com/Rust-for-Linux/linux/issues/2" tabindex="0">Unstable features</a></li><li class="chapter-item"><a href="https://github.com/Rust-for-Linux/linux/contribute" tabindex="0">Good first issues</a></li><li class="part-title">Documentation</li><li class="chapter-item"><a href="https://docs.kernel.org/rust/quick-start.html" tabindex="0">Quick Start guide</a></li><li class="chapter-item"><a href="https://docs.kernel.org/rust/" tabindex="0">Kernel documentation (mainline)</a></li><li class="chapter-item"><a href="https://docs.kernel.org/next/rust/" tabindex="0">Kernel documentation (next)</a></li><li class="chapter-item"><a href="https://rust.docs.kernel.org" tabindex="0">Rust code documentation (mainline)</a></li><li class="chapter-item"><a href="https://rust.docs.kernel.org/next/" tabindex="0">Rust code documentation (next)</a></li><li class="chapter-item"><a href="https://github.com/Rust-for-Linux/rust-out-of-tree-module" tabindex="0">Out-of-tree module template</a></li><li class="part-title">Main branches</li><li class="chapter-item"><a href="https://github.com/Rust-for-Linux/linux/tree/rust-next" tabindex="0"><span class="rfl-mono-font">rust-next</span></a></li><li class="chapter-item"><a href="https://github.com/Rust-for-Linux/linux/tree/rust-fixes" tabindex="0"><span class="rfl-mono-font">rust-fixes</span></a></li><li class="part-title">Subtree branches</li><li class="chapter-item"><a href="https://github.com/Rust-for-Linux/linux/tree/alloc-next" tabindex="0"><span class="rfl-mono-font">alloc-next</span></a></li><li class="chapter-item"><a href="https://github.com/Rust-for-Linux/linux/tree/pin-init-next" tabindex="0"><span class="rfl-mono-font">pin-init-next</span></a></li><li class="chapter-item"><a href="https://github.com/Rust-for-Linux/linux/tree/timekeeping-next" tabindex="0"><span class="rfl-mono-font">timekeeping-next</span></a></li><li class="chapter-item"><a href="https://github.com/Rust-for-Linux/linux/tree/xarray-next" tabindex="0"><span class="rfl-mono-font">xarray-next</span></a></li><li class="part-title">Patchwork</li><li class="chapter-item"><a href="https://patchwork.kernel.org/project/rust-for-linux/list/" tabindex="0">Patchwork</a></li><li class="part-title">Conferences</li><li class="chapter-item"><a href="https://kangrejos.com" tabindex="0">Kangrejos</a></li><li class="chapter-item"><a href="https://lpc.events" tabindex="0">Linux Plumbers Conference (LPC)</a></li><li class="chapter-item"><a href="https://lpc.events/event/19/sessions/223/" tabindex="0">Rust MC at LPC 2025</a></li><li class="chapter-item"><a href="https://lpc.events/event/18/sessions/186/" tabindex="0">Rust MC at LPC 2024</a></li><li class="chapter-item"><a href="https://lpc.events/event/17/sessions/170/" tabindex="0">Rust MC at LPC 2023</a></li><li class="chapter-item"><a href="https://lpc.events/event/16/sessions/150/" tabindex="0">Rust MC at LPC 2022</a></li><li class="part-title">LWN</li><li class="chapter-item"><a href="https://lwn.net/Kernel/Index/#Development_tools-Rust" tabindex="0">Rust index</a></li><li class="chapter-item"><a href="https://lwn.net/Archives/ConferenceIndex/#Kangrejos" tabindex="0">Kangrejos index</a></li><li class="part-title">Tools and toolchains</li><li class="chapter-item"><a href="https://kernel.org/pub/tools/llvm/rust/" tabindex="0">kernel.org prebuilt LLVM+Rust</a></li><li class="chapter-item"><a href="https://github.com/rust-lang/rustc_codegen_gcc" tabindex="0"><span class="rfl-mono-font">rustc_codegen_gcc</span></a></li><li class="chapter-item"><a href="https://rust-gcc.github.io" tabindex="0">Rust GCC</a></li><li class="chapter-item"><a href="https://github.com/acmel/dwarves" tabindex="0"><span class="rfl-mono-font">pahole</span></a></li><li class="part-title">Other trees</li><li class="chapter-item"><a href="https://git.kernel.org/linus/" tabindex="0">Linus' tree</a></li><li class="chapter-item"><a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/" tabindex="0">Stable tree</a></li><li class="chapter-item"><a href="https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/" tabindex="0"><span class="rfl-mono-font">linux-next</span> tree</a></li><li class="part-title">Other resources</li><li class="chapter-item"><a href="https://elixir.bootlin.com/linux/latest/source/rust" tabindex="0">Bootlin's Elixir</a></li><li class="chapter-item"><a href="https://godbolt.org/z/a55MozK6s" tabindex="0">Compiler Explorer</a></li><li class="chapter-item"><a href="https://play.rust-lang.org/?version=nightly&mode=debug&edition=2021" tabindex="0">Rust Playground</a></li><li class="chapter-item"><a href="https://doc.rust-lang.org/core/" tabindex="0">Rust <span class="rfl-mono-font">core</span> docs</a></li></ol>
        
        </div>
    
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust for Linux</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Rust-for-Linux/rust-for-linux.com" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="null-block-driver"><a class="header" href="#null-block-driver">Null Block Driver</a></h1>
<p>The Rust null block driver <code>rnull</code> is an effort to implement a drop in
replacement for <code>null_blk</code> in Rust.</p>
<p>A null block driver is a good opportunity to evaluate Rust bindings for the
block layer. It is a small and simple driver and thus should be simple to reason
about. Further, the null block driver is not usually deployed in production
environments. Thus, it should be fairly straight forward to review, and any
potential issues are not going to bring down any production workloads.</p>
<p>Being small and simple, the null block driver is a good place to introduce the
Linux kernel storage community to Rust. This will help prepare the community for
future Rust projects and facilitate a better maintenance process for these
projects.</p>
<p><a href="https://lore.kernel.org/all/87y1ofj5tt.fsf@metaspace.dk/">Statistics</a> from the
commit log of the <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/drivers/block/null_blk?h=v6.1">C <code>null_blk</code>
driver</a>
(<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/drivers/block/null_blk_main.c?h=v6.1&amp;id=ea17fd354ca8afd3e8962a77236b1a9a59262fdd">before
move</a>)
show that the C null block driver has had a significant amount of memory safety
related problems in the past. 41% of fixes merged for the C null block driver
are fixes for memory safety issues. This makes the null block driver a good
candidate for rewriting in Rust.</p>
<p>The driver is implemented entirely in safe Rust, with all unsafe code fully
contained in the abstractions that wrap the C APIs.</p>
<p>Please note that the performance measurements on this page might be misleading
due to the results not being normally distributed. <a href="https://metaspace.github.io/2024/12/02/problems-in-benchmark-land.html">This
analysis</a>
has more details. We observe that issue is resovled for v6.14-rc5, but we are
monitoring the situation going forward.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<p>Implemented features:</p>
<ul>
<li><code>blk-mq</code> support</li>
<li>Direct completion</li>
<li>SoftIRQ completion</li>
<li>Timer completion</li>
<li>Read and write requests</li>
<li>Optional memory backing</li>
<li>Bio-based submission</li>
<li>NUMA support</li>
<li>Block size configuration</li>
<li>Multiple devices</li>
<li>Dynamic device creation/destruction</li>
<li>Queue count configuration</li>
<li>Per node hctx</li>
<li>Queue depth configuration</li>
<li>Discard operation support</li>
<li>Cache emulation</li>
<li>Bandwidth throttling</li>
<li>IO scheduler configuration</li>
<li>Blocking submission mode</li>
<li>Shared tags configuration (for &gt;1 device)</li>
<li>Bad block simulation</li>
</ul>
<p>Features available in the C <code>null_blk</code> driver that are currently not implemented
in this work:</p>
<ul>
<li>Zoned storage support</li>
<li>Poll queues</li>
</ul>
<h2 id="resources"><a class="header" href="#resources">Resources</a></h2>
<ul>
<li><a href="https://git.kernel.org/pub/scm/linux/kernel/git/a.hindborg/linux.git/log/?h=rnull">Latest patches</a></li>
<li><a href="https://github.com/metaspace/linux/tree/null_block-RFC">Original RFC Patches</a></li>
<li><a href="https://lore.kernel.org/all/20230503090708.2524310-1-nmi@metaspace.dk/">Mailing List Post</a></li>
<li><a href="https://lore.kernel.org/all/20240611114551.228679-1-nmi@metaspace.dk/">Subset merged in v6.11-rc1</a></li>
</ul>
<h2 id="618-rc5-rebase-rnull-v618-rc5"><a class="header" href="#618-rc5-rebase-rnull-v618-rc5">6.18-rc5, Rebase (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/a.hindborg/linux.git/log/?h=rnull-v6.18-rc5"><code>rnull-v6.18-rc5</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.17.7</code>:</p>
<ul>
<li>Add bandwidth throttling</li>
<li>Add blocking queue mode</li>
<li>Add shared tags support</li>
<li>Add queue depth configuration option</li>
</ul>
<h3 id="performance"><a class="header" href="#performance">Performance</a></h3>
<h4 id="setup"><a class="header" href="#setup">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.11</li>
</ul>
<h4 id="results"><a class="header" href="#results">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.18-rc5.svg" alt="" /></p>
<h5 id="sample-distribution"><a class="header" href="#sample-distribution">Sample Distribution</a></h5>
<ul>
<li>C left bounded by blue line.</li>
<li>Rust right bounded by orange line.</li>
</ul>
<p><img src="rnull/rnull-v6.18-rc5-density.svg" alt="" /></p>
<h2 id="617-rebase-rnull-v6177"><a class="header" href="#617-rebase-rnull-v6177">6.17 Rebase (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/a.hindborg/linux.git/log/?h=rnull-v6.17.7"><code>rnull-v6.17.7</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.16</code>:</p>
<ul>
<li>Add discard support</li>
<li>Add no_sched support</li>
<li>Add badblocks emulation</li>
<li>Add volatile cache emulation</li>
</ul>
<h3 id="performance-1"><a class="header" href="#performance-1">Performance</a></h3>
<h4 id="setup-1"><a class="header" href="#setup-1">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.11</li>
</ul>
<h4 id="results-1"><a class="header" href="#results-1">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.17.7.svg" alt="" /></p>
<h5 id="sample-distribution-1"><a class="header" href="#sample-distribution-1">Sample Distribution</a></h5>
<ul>
<li>C left bounded by blue line.</li>
<li>Rust right bounded by orange line.</li>
</ul>
<p><img src="rnull/rnull-v6.17.7-density.svg" alt="" /></p>
<h2 id="616-rebase-rnull-v616"><a class="header" href="#616-rebase-rnull-v616">6.16 Rebase (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/a.hindborg/linux.git/log/?h=rnull-v6.16"><code>rnull-v6.16</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.15</code>:</p>
<ul>
<li>No changes</li>
</ul>
<h3 id="performance-2"><a class="header" href="#performance-2">Performance</a></h3>
<h4 id="setup-2"><a class="header" href="#setup-2">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.11</li>
</ul>
<h4 id="results-2"><a class="header" href="#results-2">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.16.svg" alt="" /></p>
<h5 id="sample-distribution-2"><a class="header" href="#sample-distribution-2">Sample Distribution</a></h5>
<ul>
<li>C left bounded by blue line.</li>
<li>Rust right bounded by orange line.</li>
</ul>
<p><img src="rnull/rnull-v6.16-density.svg" alt="" /></p>
<h2 id="615-rebase-rnull-v615"><a class="header" href="#615-rebase-rnull-v615">6.15 Rebase (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/a.hindborg/linux.git/log/?h=rnull-v6.15"><code>rnull-v6.15</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.14</code>:</p>
<ul>
<li>No changes</li>
</ul>
<h3 id="performance-3"><a class="header" href="#performance-3">Performance</a></h3>
<h4 id="setup-3"><a class="header" href="#setup-3">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.11</li>
</ul>
<h4 id="results-3"><a class="header" href="#results-3">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.15.svg" alt="" /></p>
<h5 id="sample-distribution-3"><a class="header" href="#sample-distribution-3">Sample Distribution</a></h5>
<ul>
<li>C left bounded by blue line.</li>
<li>Rust right bounded by orange line.</li>
</ul>
<p><img src="rnull/rnull-v6.15-density.svg" alt="" /></p>
<h2 id="614-rc5-rebase-rnull-v614-rc5"><a class="header" href="#614-rc5-rebase-rnull-v614-rc5">6.14-rc5 Rebase (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/a.hindborg/linux.git/log/?h=rnull-v6.14-rc5"><code>rnull-v6.14-rc5</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.13</code>:</p>
<ul>
<li>Change reference counting scheme for <code>Request</code>.</li>
<li>Move <code>rnull</code> driver to separate directory.</li>
<li>Rename <code>RawWriter</code> to <code>BufferWriter</code> and move it.</li>
<li>Enable configuration of <code>rnull</code> via <code>configfs</code>.
<ul>
<li>Enable dynamic createion/destruction of devices via <code>configfs</code>.</li>
</ul>
</li>
<li>Use <code>Owned</code> for rust managed <code>Page</code> objects.</li>
<li>Change segment iterator to prevent concurrent mutable access to pages.</li>
<li>Use <code>GFP_NOIO</code> flag for backing rnull pages.</li>
<li>Add <code>user_per_node_hctx</code> rnull config option.</li>
<li>Add NUMA home node rnull config option.</li>
<li>Add submit queue count rnull config option.</li>
<li>Fix a bug where unwritten bytes were not zeroed on read.</li>
<li>Properly handle IO requests that are not equal in size to one block.</li>
</ul>
<h3 id="performance-4"><a class="header" href="#performance-4">Performance</a></h3>
<h4 id="setup-4"><a class="header" href="#setup-4">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.11</li>
</ul>
<h4 id="results-4"><a class="header" href="#results-4">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.14-rc5.svg" alt="" /></p>
<h2 id="613-rebase-rnull-v613"><a class="header" href="#613-rebase-rnull-v613">6.13 Rebase (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/a.hindborg/linux.git/log/?h=rnull-v6.13"><code>rnull-v6.13</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.12</code>:</p>
<ul>
<li>None</li>
</ul>
<h3 id="performance-5"><a class="header" href="#performance-5">Performance</a></h3>
<h4 id="setup-5"><a class="header" href="#setup-5">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.05</li>
</ul>
<h4 id="results-5"><a class="header" href="#results-5">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.13.svg" alt="" /></p>
<h2 id="612-rebase-rnull-v612"><a class="header" href="#612-rebase-rnull-v612">6.12 Rebase (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/a.hindborg/linux.git/log/?h=rnull-v6.12"><code>rnull-v6.12</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.12-rc2</code>:</p>
<ul>
<li>None</li>
</ul>
<h3 id="performance-6"><a class="header" href="#performance-6">Performance</a></h3>
<h4 id="setup-6"><a class="header" href="#setup-6">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.05</li>
</ul>
<h4 id="results-6"><a class="header" href="#results-6">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.12.svg" alt="" /></p>
<h2 id="612-rc2-rebase-rnull-v612-rc2"><a class="header" href="#612-rc2-rebase-rnull-v612-rc2">6.12-rc2 Rebase (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/a.hindborg/linux.git/log/?h=rnull-v6.12-rc2"><code>rnull-v6.12-rc2</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.11</code>:</p>
<ul>
<li>Make <code>QueueData</code> references pinned.</li>
</ul>
<h3 id="performance-7"><a class="header" href="#performance-7">Performance</a></h3>
<h4 id="setup-7"><a class="header" href="#setup-7">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.05</li>
</ul>
<h4 id="results-7"><a class="header" href="#results-7">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.12-rc2.svg" alt="" /></p>
<h2 id="611-rebase-rnull-v611"><a class="header" href="#611-rebase-rnull-v611">6.11 Rebase (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/a.hindborg/linux.git/log/?h=rnull-v6.11"><code>rnull-v6.11</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.10</code>:</p>
<ul>
<li>None.</li>
</ul>
<h3 id="performance-8"><a class="header" href="#performance-8">Performance</a></h3>
<h4 id="setup-8"><a class="header" href="#setup-8">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.05</li>
</ul>
<h4 id="results-8"><a class="header" href="#results-8">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.11.svg" alt="" /></p>
<h2 id="611-rc2-rebase-rnull-v611-rc2"><a class="header" href="#611-rc2-rebase-rnull-v611-rc2">6.11-rc2 Rebase (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/a.hindborg/linux.git/log/?h=rnull-v6.11-rc2"><code>rnull-v6.11-rc2</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.10</code>:</p>
<ul>
<li>Base abstractions merged upstream ðŸ¥³</li>
<li>Use atomic queue limits C API for setting queue limits.</li>
</ul>
<h3 id="performance-9"><a class="header" href="#performance-9">Performance</a></h3>
<h4 id="setup-9"><a class="header" href="#setup-9">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.05</li>
</ul>
<h4 id="results-9"><a class="header" href="#results-9">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.11-rc2.svg" alt="" /></p>
<h2 id="610-rebase-rnull-v610"><a class="header" href="#610-rebase-rnull-v610">6.10 Rebase (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/a.hindborg/linux.git/log/?h=rnull-v6.10"><code>rnull-v6.10</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.10-rc3</code>:</p>
<ul>
<li>None</li>
</ul>
<h3 id="performance-10"><a class="header" href="#performance-10">Performance</a></h3>
<h4 id="setup-10"><a class="header" href="#setup-10">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.05</li>
</ul>
<h4 id="results-10"><a class="header" href="#results-10">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.10.svg" alt="" /></p>
<h2 id="610-rc3-rebase-rnull-v610-rc3"><a class="header" href="#610-rc3-rebase-rnull-v610-rc3">6.10-rc3 Rebase (<a href="https://github.com/metaspace/linux/tree/rnull-v6.10-rc3"><code>rnull-v6.10-rc3</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.9</code>:</p>
<ul>
<li>Add <code>ForeignBorrowed</code>.</li>
<li>Move <code>GenDisk</code> to a builder pattern instead of typestate pattern.</li>
<li>Move block size validation from driver to abstractions.</li>
<li>Pin <code>NullBlkModuel</code>.</li>
<li>Refactor <code>Request::try_set_end</code>.</li>
<li>Rewrite atomic functions in terms of <code>core</code> library functions.</li>
<li>Fix a bug in timer completions where an offset was not calculated correctly.</li>
<li>Refactor <code>TagSet</code> initialization in terms of <code>core::mem::zeroed()</code> instead of <code>Opaque::try_ffi_init</code></li>
</ul>
<h3 id="performance-11"><a class="header" href="#performance-11">Performance</a></h3>
<h4 id="setup-11"><a class="header" href="#setup-11">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.05</li>
</ul>
<h4 id="results-11"><a class="header" href="#results-11">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.10-rc3.svg" alt="" /></p>
<h2 id="69-rebase-rnull-v69"><a class="header" href="#69-rebase-rnull-v69">6.9 Rebase (<a href="https://github.com/metaspace/linux/tree/rnull-v6.9"><code>rnull-v6.9</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.8</code>:</p>
<ul>
<li>Do not rely on C refcounting of <code>Request</code></li>
<li>Use <code>ARef</code> to track <code>Request</code> lifetime</li>
<li>Use <code>Page</code> instead of <code>Folio</code> to track memory for memory backed mode</li>
<li>Use typestate pattern to track state of <code>GenDisk</code></li>
<li>Panic when requests cannot be completed</li>
<li>Remove associated type <code>RequestDataInit</code> and use return position impl trait instead</li>
<li>Call <code>Request::start</code> implicitly</li>
<li>Split helper function C file</li>
</ul>
<h3 id="performance-12"><a class="header" href="#performance-12">Performance</a></h3>
<h4 id="setup-12"><a class="header" href="#setup-12">Setup</a></h4>
<ul>
<li>AMD Ryzen 5 7600</li>
<li>32 GB 4800 MT/s DDR5 on one channel</li>
<li>1x Samsung 990 Pro 1TB (PCIe 4.0 x4 16 GT/S)</li>
<li>NixOS 24.05</li>
</ul>
<h4 id="results-12"><a class="header" href="#results-12">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>5 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.9.svg" alt="" /></p>
<h2 id="68-rebase-rnull-v68"><a class="header" href="#68-rebase-rnull-v68">6.8 Rebase (<a href="https://github.com/metaspace/linux/tree/rnull-v6.8"><code>rnull-v6.8</code></a>)</a></h2>
<p>Changes from <code>rnull-v6.8-rc6</code>:</p>
<ul>
<li>Slight refactoring of patch order</li>
</ul>
<h3 id="performance-13"><a class="header" href="#performance-13">Performance</a></h3>
<h4 id="setup-13"><a class="header" href="#setup-13">Setup</a></h4>
<ul>
<li>12th Gen Intel(R) Core(TM) i5-12600</li>
<li>32 GB DRAM</li>
<li>Debian Bullseye userspace</li>
</ul>
<h4 id="results-13"><a class="header" href="#results-13">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>5 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.8.svg" alt="" /></p>
<h2 id="68-rc6-rebase-rnull-v68-rc6"><a class="header" href="#68-rc6-rebase-rnull-v68-rc6">6.8-rc6 Rebase (<a href="https://github.com/metaspace/linux/tree/rnull-v6.8-rc6"><code>rnull-v6.8-rc6</code></a>)</a></h2>
<p>Changes from <code>rnull-6.8</code>:</p>
<ul>
<li>Change lock alignment mechanics</li>
<li>Apply reference counting to <code>Request</code></li>
<li>Drop some inline directives</li>
</ul>
<h3 id="performance-14"><a class="header" href="#performance-14">Performance</a></h3>
<h4 id="setup-14"><a class="header" href="#setup-14">Setup</a></h4>
<ul>
<li>12th Gen Intel(R) Core(TM) i5-12600</li>
<li>32 GB DRAM</li>
<li>Debian Bullseye userspace</li>
</ul>
<h4 id="results-14"><a class="header" href="#results-14">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>5 samples for each configuration</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-v6.8-rc6.svg" alt="" /></p>
<h2 id="67-rebase-rnull-67"><a class="header" href="#67-rebase-rnull-67">6.7 Rebase (<a href="https://github.com/metaspace/linux/tree/rnull-6.7"><code>rnull-6.7</code></a>)</a></h2>
<p>Changes from null_blk-6.6:</p>
<ul>
<li>Move to <code>Folio</code> for memory backing instead of <code>Page</code></li>
<li>Move to <code>XArray</code> for memory backing instead of <code>RaddixTree</code></li>
</ul>
<h3 id="performance-15"><a class="header" href="#performance-15">Performance</a></h3>
<h4 id="setup-15"><a class="header" href="#setup-15">Setup</a></h4>
<ul>
<li>12th Gen Intel(R) Core(TM) i5-12600</li>
<li>32 GB DRAM</li>
<li>Debian Bullseye userspace</li>
</ul>
<h4 id="results-15"><a class="header" href="#results-15">Results</a></h4>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/rnull-6.7.svg" alt="" /></p>
<h2 id="performance-september-2023-null_blk-66"><a class="header" href="#performance-september-2023-null_blk-66">Performance September 2023 (<a href="https://github.com/metaspace/linux/tree/null_blk-6.6"><code>null_blk-6.6</code></a>)</a></h2>
<h3 id="setup-16"><a class="header" href="#setup-16">Setup</a></h3>
<ul>
<li>12th Gen Intel(R) Core(TM) i5-12600</li>
<li>32 GB DRAM</li>
<li>1x INTEL MEMPEK1W016GA (PCIe 3.0 x2)</li>
<li>Debian Bullseye userspace</li>
</ul>
<h3 id="results-16"><a class="header" href="#results-16">Results</a></h3>
<ul>
<li>Plot shows <code>(mean_iops_r - mean_iops_c) / mean_iops_c</code></li>
<li>40 samples</li>
<li>Difference of means modeled with t-distribution</li>
<li>P95 confidence intervals</li>
</ul>
<p><img src="rnull/null_blk-6.6.svg" alt="" /></p>
<h2 id="performance-september-2023"><a class="header" href="#performance-september-2023">Performance September 2023</a></h2>
<h3 id="setup-17"><a class="header" href="#setup-17">Setup</a></h3>
<ul>
<li>12th Gen Intel(R) Core(TM) i5-12600</li>
<li>32 GB DRAM</li>
<li>1x INTEL MEMPEK1W016GA (PCIe 3.0 x2)</li>
<li>Debian Bullseye userspace</li>
</ul>
<h3 id="results-17"><a class="header" href="#results-17">Results</a></h3>
<p>In most cases there is less than 2% difference between the Rust and C drivers.</p>
<p><img src="./rnull/read-iops.svg" alt="" />
<img src="./rnull/write-iops.svg" alt="" />
<img src="./rnull/randread-iops.svg" alt="" />
<img src="./rnull/randwrite-iops.svg" alt="" />
<img src="./rnull/readwrite-iops.svg" alt="" />
<img src="./rnull/randrw-iops.svg" alt="" /></p>
<h2 id="contact"><a class="header" href="#contact">Contact</a></h2>
<p>Please contact Andreas Hindborg through
<a href="Contact.html#zulip-chat">Zulip</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="Nova-GPU-Driver.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="Tyr-GPU-Driver.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="Nova-GPU-Driver.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="Tyr-GPU-Driver.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
